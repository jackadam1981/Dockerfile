name: Build from repo URL

# éœ€è¦è®¾ç½®çš„å˜é‡
# DOCKERHUB_USERNAME dockerhubçš„è´¦å·
# DOCKERHUB_PASSWORD dockerhubçš„å¯†ç 
# éœ€è¦è®¾ç½®çš„è¾“å…¥
# reop_name dockerhubçš„é¡¹ç›®å
# reop_url é¡¹ç›®çš„cloneåœ°å€
# version æ ‡è¯†çš„ç‰ˆæœ¬
# dockerfile_path Dockerfileè·¯å¾„ (å¯é€‰ï¼Œå¦‚æœä¸åœ¨æ ¹ç›®å½•)

on:
    workflow_dispatch:
        inputs:
            reop_name:
                description: 'Name,DockerHubçš„é¡¹ç›®å'
                required: true
                default: 
            reop_url:
                description: 'RepoUrl,é¡¹ç›®çš„cloneåœ°å€ï¼Œé‡Œé¢è¦æœ‰dockerfile'
                required: true
                default: 
            version:
                description: 'VERSIONï¼Œæ ‡è¯†çš„ç‰ˆæœ¬'
                required: true
                default: 
            dockerfile_path:
                description: 'Dockerfileè·¯å¾„ (å¯é€‰ï¼Œå¦‚æœä¸åœ¨æ ¹ç›®å½•)'
                required: false
                default: 'Dockerfile'

run-name: ${{ github.actor }} is testing build ${{ github.event.inputs.reop_name }}:${{ github.event.inputs.version }} from ${{ github.event.inputs.reop_url }} ğŸš€

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    
      - name: Clone custom repository
        run: git clone ${{ github.event.inputs.reop_url }} .

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Docker login
        uses: docker/login-action@v2
        with:
            username: "${{ secrets.DOCKERHUB_USERNAME }}"
            password: "${{ secrets.DOCKERHUB_PASSWORD }}"
      
      - name: Build and push images
        uses: docker/build-push-action@v4
        with:
            context: .
            file: ${{ github.event.inputs.dockerfile_path }}
            platforms: linux/arm/v6,linux/arm/v7,amd64,linux/arm64
            push: true
            tags: "jackadam/${{ github.event.inputs.reop_name }}:${{ github.event.inputs.version }},jackadam/${{ github.event.inputs.reop_name }}:latest"
      
        # ç°åœ¨ä»“åº“åº”è¯¥å·²å­˜åœ¨ï¼Œå¯ä»¥æ›´æ–°æè¿°
      - name: push README to Dockerhub
        uses: christian-korneck/update-container-description-action@v1
        env:
            DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
            DOCKER_PASS: ${{ secrets.DOCKERHUB_PASSWORD }}
        with:
            destination_container_repo: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.inputs.reop_name }}
            provider: dockerhub
            short_description: 'my short description ğŸ˜Š'
            readme_file: 'README.md'